@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject AuthService AuthService
@implements IAsyncDisposable
@rendermode InteractiveWebAssembly

<PageTitle>SimpleChat - Discord Style</PageTitle>

@if (session == null)
{
    <div class="flex items-center justify-center h-screen">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
    </div>
}
else
{
    <div class="flex h-[calc(100vh-64px)] overflow-hidden bg-white">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-100 flex flex-col border-r">
            <div class="p-4 flex flex-col flex-grow overflow-y-auto space-y-6">
                <!-- Text Channels -->
                <div>
                    <div class="flex items-center justify-between text-gray-500 uppercase text-xs font-bold px-2 mb-2">
                        <span>Text Channels</span>
                        <button @onclick='() => ShowCreateDialog(false)' class="hover:text-gray-900 text-lg">+</button>
                    </div>
                    <div class="space-y-1">
                        @foreach (var ch in textChannels)
                        {
                            <button @onclick="() => JoinTextChannel(ch)" 
                                    class="w-full text-left px-2 py-1 rounded transition @(currentTextChannel == ch ? "bg-gray-300 text-gray-900" : "hover:bg-gray-200 text-gray-600")">
                                <span class="text-gray-400 mr-2">#</span>@ch
                            </button>
                        }
                    </div>
                </div>

                <!-- Voice Channels -->
                <div>
                    <div class="flex items-center justify-between text-gray-500 uppercase text-xs font-bold px-2 mb-2">
                        <span>Voice Channels</span>
                        <button @onclick='() => ShowCreateDialog(true)' class="hover:text-gray-900 text-lg">+</button>
                    </div>
                    <div class="space-y-1">
                        @foreach (var ch in voiceChannels)
                        {
                            <button @onclick="() => JoinVoiceChannel(ch)" 
                                    class="w-full text-left px-2 py-1 rounded transition @(currentVoiceChannel == ch ? "bg-gray-300 text-gray-900" : "hover:bg-gray-200 text-gray-600")">
                                <span class="text-gray-400 mr-2">
                                    <svg class="inline w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.983 5.983 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.983 3.983 0 0013 10a3.983 3.983 0 00-1.172-2.828a1 1 0 010-1.415z" clip-rule="evenodd" /></svg>
                                </span>@ch
                            </button>
                        }
                    </div>
                </div>
            </div>

            <!-- Voice Status / Controls -->
            @if (!string.IsNullOrEmpty(currentVoiceChannel))
            {
                <div class="p-3 bg-gray-200 border-t">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex flex-col">
                            <span class="text-xs text-green-600 font-bold uppercase">Voice Connected: @(peerCount + 1) users</span>
                            <span class="text-sm font-medium">@currentVoiceChannel</span>
                        </div>
                        <button @onclick="LeaveVoice" class="text-gray-500 hover:text-red-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z" /></svg>
                        </button>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button @onclick="ToggleMute" class="p-2 rounded hover:bg-gray-300 @(!isMuted ? "text-red-500" : "text-gray-600")">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" /></svg>
                        </button>
                        <input type="range" class="flex-grow h-1 bg-gray-400 rounded-lg appearance-none cursor-pointer accent-blue-600" 
                               min="0" max="1" step="0.01" @bind="volume" @bind:event="oninput" @onchange="UpdateVolume" />
                    </div>
                </div>
            }
        </div>

        <!-- Main Chat Area -->
        <div class="flex-grow flex flex-col bg-white">
            @if (!string.IsNullOrEmpty(currentTextChannel))
            {
                <div class="h-12 border-b flex items-center px-4 shadow-sm z-10">
                    <span class="text-gray-400 text-2xl mr-2">#</span>
                    <span class="font-bold">@currentTextChannel</span>
                </div>
                <div class="flex-grow overflow-y-auto p-4 space-y-4" id="chat-container">
                    @foreach (var msg in messages.Where(m => m.ChannelName == currentTextChannel).OrderBy(m => m.Timestamp))
                    {
                        <div class="flex space-x-3 group hover:bg-gray-50 -mx-4 px-4 py-1 transition-colors">
                            <div class="w-10 h-10 rounded-full bg-blue-500 flex-shrink-0 flex items-center justify-center text-white font-bold shadow-sm">
                                @msg.Username.Substring(0, Math.Min(2, msg.Username.Length)).ToUpper()
                            </div>
                            <div class="flex-grow">
                                <div class="flex items-baseline space-x-2">
                                    <span class="font-bold hover:underline cursor-pointer text-gray-900">@msg.Username</span>
                                    <span class="text-[10px] text-gray-400 font-medium">@msg.Timestamp.ToLocalTime().ToString("MMM dd, h:mm tt")</span>
                                </div>
                                <p class="text-gray-700 leading-relaxed">@msg.Content</p>
                            </div>
                        </div>
                    }
                </div>
                <div class="p-4">
                    <div class="bg-gray-100 rounded-lg px-4 py-2 flex items-center space-x-3 focus-within:ring-2 focus-within:ring-blue-500 transition-all shadow-inner">
                        <button class="text-gray-400 hover:text-gray-600 text-xl font-bold">+</button>
                        <input type="text" class="bg-transparent flex-grow outline-none py-1 text-gray-800" 
                               placeholder="Message #@currentTextChannel" @bind="newMessage" @onkeyup="HandleKeyUp" />
                    </div>
                </div>
            }
            else
            {
                <div class="flex-grow flex items-center justify-center text-gray-400 flex-col space-y-4">
                    <div class="bg-gray-50 p-8 rounded-full">
                        <svg class="w-24 h-24 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
                    </div>
                    <div class="text-center">
                        <h3 class="text-xl font-bold text-gray-600">No channel selected</h3>
                        <p class="text-gray-400">Select a text channel from the sidebar to start chatting</p>
                    </div>
                </div>
            }
        </div>
    </div>
}

<!-- Simple Create Dialog -->
@if (showCreateDialog)
{
    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 backdrop-blur-sm transition-opacity">
        <div class="bg-white p-8 rounded-2xl w-[400px] shadow-2xl border border-gray-100">
            <h2 class="text-2xl font-black mb-2 text-gray-900">Create @(isCreatingVoice ? "Voice" : "Text") Channel</h2>
            <p class="text-sm text-gray-500 mb-6">Channels are where your team communicates.</p>
            
            <label class="block text-xs font-bold uppercase text-gray-500 mb-2">Channel Name</label>
            <input @bind="newChannelName" @bind:event="oninput" 
                   class="w-full border-2 border-gray-100 bg-gray-50 rounded-xl px-4 py-3 mb-6 outline-none focus:border-blue-500 focus:bg-white transition-all text-gray-800 font-medium" 
                   placeholder="e.g. general-discussion" />
            
            <div class="flex justify-end items-center space-x-4">
                <button @onclick="() => showCreateDialog = false" class="text-gray-500 font-bold hover:text-gray-700 px-2 transition-colors">Cancel</button>
                <button @onclick="CreateChannel" disabled='@string.IsNullOrWhiteSpace(newChannelName)'
                        class="bg-blue-600 hover:bg-blue-700 text-white font-bold px-8 py-3 rounded-xl shadow-lg shadow-blue-200 transition-all disabled:opacity-50 disabled:shadow-none">
                    Create Channel
                </button>
            </div>
        </div>
    </div>
}

@code {
    private HubConnection? hubConnection;
    private bool isRecording = false;
    private bool isMuted = true;
    private double volume = 0.5;
    private int peerCount = 0;
    
    private string currentTextChannel = "";
    private string currentVoiceChannel = "";
    private string newMessage = "";
    private string newChannelName = "";
    private bool showCreateDialog = false;
    private bool isCreatingVoice = false;
    private UserSession? session;

    private List<string> textChannels = new();
    private List<string> voiceChannels = new();
    private List<ChatMessage> messages = new();
    private DotNetObjectReference<Home>? objRef;

    public class ChatMessage
    {
        public string Username { get; set; } = "";
        public string ChannelName { get; set; } = "";
        public string Content { get; set; } = "";
        public bool IsMe { get; set; }
        public DateTime Timestamp { get; set; } = DateTime.UtcNow;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                await JS.InvokeVoidAsync("console.log", "Home.OnAfterRenderAsync started");
                try
                {
                    session = await AuthService.GetSession();
                }
                catch (Exception ex)
                {
                    await JS.InvokeVoidAsync("console.warn", "AuthService.GetSession failed", ex.ToString());
                }

                if (session == null)
                {
                    await JS.InvokeVoidAsync("console.log", "No session, navigating to /login");
                    Navigation.NavigateTo("/login");
                    return;
                }

                await JS.InvokeVoidAsync("console.log", "Building HubConnection");
                hubConnection = new HubConnectionBuilder()
                    .WithUrl(Navigation.ToAbsoluteUri("/audiohub"))
                    .WithAutomaticReconnect()
                    .Build();

                hubConnection.On<string, string>("ReceiveSignal", async (remoteId, signal) =>
                {
                    if (signal == "JOIN")
                    {
                        if (isRecording)
                        {
                            string offer = await JS.InvokeAsync<string>("webRtcAudio.initiateOffer", remoteId);
                            await hubConnection!.SendAsync("SendSignal", remoteId, offer, currentVoiceChannel);
                        }
                    }
                    else
                    {
                        await JS.InvokeVoidAsync("webRtcAudio.processSignal", remoteId, signal);
                    }
                });

                hubConnection.On<string, string, string, DateTime>("ReceiveChatMessage", async (user, channel, text, ts) =>
                {
                    messages.Add(new ChatMessage { Username = user, ChannelName = channel, Content = text, IsMe = session != null && user == session.Username, Timestamp = ts });
                    await InvokeAsync(StateHasChanged);
                    await JS.InvokeVoidAsync("console.log", $"Message received in {channel}: {text}");
                    await ScrollToBottom();
                });

                hubConnection.On<string, List<ChatMessage>>("ReceiveChatHistory", async (channel, history) =>
                {
                    // Remove existing messages for this channel to avoid duplicates
                    messages.RemoveAll(m => m.ChannelName == channel);
                    foreach(var m in history) m.IsMe = session != null && m.Username == session.Username;
                    messages.AddRange(history);
                    await InvokeAsync(StateHasChanged);
                    await JS.InvokeVoidAsync("console.log", $"History received for {channel}: {history.Count} messages");
                    await ScrollToBottom();
                });

                hubConnection.On<List<string>, List<string>>("UpdateChannels", async (tChans, vChans) =>
                {
                    textChannels = tChans;
                    voiceChannels = vChans;
                    await InvokeAsync(StateHasChanged);
                });

                await JS.InvokeVoidAsync("console.log", "Initializing webRtcAudio");
                objRef = DotNetObjectReference.Create(this);
                await JS.InvokeVoidAsync("webRtcAudio.init", objRef);
                
                await JS.InvokeVoidAsync("console.log", "Starting HubConnection");
                await hubConnection.StartAsync();
                
                await JS.InvokeVoidAsync("console.log", "Updating volume");
                await UpdateVolume();
                StateHasChanged();
                await JS.InvokeVoidAsync("console.log", "Home.OnAfterRenderAsync finished");
            }
            catch (Exception ex)
            {
                await JS.InvokeVoidAsync("console.error", "Error in Home.OnAfterRenderAsync", ex.ToString());
            }
        }
    }

    private async Task JoinTextChannel(string name)
    {
        currentTextChannel = name;
        if (hubConnection is not null && hubConnection.State == HubConnectionState.Connected)
        {
            await hubConnection.SendAsync("JoinTextChannel", name);
        }
    }

    private async Task JoinVoiceChannel(string name)
    {
        if (currentVoiceChannel == name) return;

        if (!string.IsNullOrEmpty(currentVoiceChannel))
        {
            await hubConnection!.SendAsync("LeaveVoiceChannel", currentVoiceChannel);
            await JS.InvokeVoidAsync("webRtcAudio.stopLocalStream");
            isRecording = false;
        }

        currentVoiceChannel = name;
        await hubConnection!.SendAsync("JoinVoiceChannel", currentVoiceChannel);
        
        bool started = await JS.InvokeAsync<bool>("webRtcAudio.startLocalStream");
        if (started)
        {
            isRecording = true;
            isMuted = true;
            await JS.InvokeVoidAsync("webRtcAudio.setMute", true);
            await hubConnection!.SendAsync("SendSignal", "all", "JOIN", currentVoiceChannel);
        }
    }

    private async Task LeaveVoice()
    {
        if (string.IsNullOrEmpty(currentVoiceChannel)) return;
        await hubConnection!.SendAsync("LeaveVoiceChannel", currentVoiceChannel);
        await JS.InvokeVoidAsync("webRtcAudio.stopLocalStream");
        isRecording = false;
        currentVoiceChannel = "";
    }

    private async Task CreateChannel()
    {
        if (string.IsNullOrWhiteSpace(newChannelName)) return;
        await hubConnection!.SendAsync("CreateChannel", newChannelName, isCreatingVoice);
        showCreateDialog = false;
        newChannelName = "";
    }

    private void ShowCreateDialog(bool isVoice) { isCreatingVoice = isVoice; showCreateDialog = true; }

    private async Task ToggleMute()
    {
        isMuted = !isMuted;
        await JS.InvokeVoidAsync("webRtcAudio.setMute", isMuted);
    }

    private async Task SendText()
    {
        if (!string.IsNullOrWhiteSpace(newMessage) && !string.IsNullOrEmpty(currentTextChannel))
        {
            await hubConnection!.SendAsync("SendChatMessage", currentTextChannel, newMessage, session?.Username);
            newMessage = "";
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter") await SendText();
    }

    [JSInvokable]
    public void UpdatePeerCount(int count)
    {
        peerCount = count;
        StateHasChanged();
    }

    [JSInvokable]
    public async Task SendSignal(string remoteId, string signal)
    {
        if (hubConnection is not null)
        {
            await hubConnection.SendAsync("SendSignal", remoteId, signal, currentVoiceChannel);
        }
    }

    private async Task UpdateVolume()
    {
        await JS.InvokeVoidAsync("webRtcAudio.setVolume", volume);
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JS.InvokeVoidAsync("scrollToBottom", "chat-container");
        }
        catch
        {
            // Ignore if element not found
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null) await hubConnection.DisposeAsync();
        objRef?.Dispose();
    }
}
